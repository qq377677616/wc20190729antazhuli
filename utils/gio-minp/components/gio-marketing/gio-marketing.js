"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var gio=require("../../index"),gio__default=_interopDefault(gio);const messageUpdateInterval=3e4;let messageData,lastTimeCallUpdateMessageTime,cs1,bu,bcs,initAppSended=!1,confirmed=[],componentCreated=!1;const equals=function(e,t){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(var a in e)if(e.hasOwnProperty(a)){if(!t.hasOwnProperty(a))return!1;if(e[a]!==t[a]){if("object"!=typeof e[a])return!1;if(!equals(e[a],t[a]))return!1}}for(a in t)if(t.hasOwnProperty(a)&&!e.hasOwnProperty(a))return!1;return!0};gio.gioEmitter.on("appShow",()=>{initAppSended=!1}),gio.gioEmitter.on("setCs1",e=>{cs1=e,updateMessageData()});const updateMessageData=()=>{if(!componentCreated)return;const e=Date.now();lastTimeCallUpdateMessageTime=e;let t=`https://messages.growingio.com/v1/${gio.growingio.projectId}/notifications?url_scheme=${gio.growingio.appId}`;if(bu)t+=`&bu=${bu}`;else{t+=`&u=${gio.growingio.weixin.uid}`}bcs?t+=`&bcs=${bcs}`:cs1&&(t+=`&cs=${cs1}`),wx.request({url:t,success:t=>{if(lastTimeCallUpdateMessageTime===e){bcs=t.data.idMappings.bcs,bu=t.data.idMappings.bu;const e=t.data;e.popupWindows=t.data.popupWindows.map(e=>({...e,content:{src:e.contentMetadata.components[0].config.src,target:Object.values(e.contentMetadata.components[0].config.target)[0]}})),equals(messageData,e)||(messageData=e,gio__default("track","appOpen"))}}})};updateMessageData(),setInterval(updateMessageData,3e4),Component({data:{display:!1,params:{},matchedPopWindows:[],messageProps:{},confirmed:[]},pageLifetimes:{hide(){gio.gioEmitter.removeListener("upload",this.handleEvent)},show(){this.handleStateChange(),gio.gioEmitter.addListener("upload",this.handleEvent),initAppSended||(gio__default("track","appOpen"),confirmed=[],initAppSended=!0)}},methods:{handleTouchMove(e){},handleConfirm(){gio__default("track","in_app_message_"+this.data.messageProps.id+"img_1_click"),confirmed=[...confirmed,this.data.messageProps.id],this.data.params.target?wx.navigateTo({url:this.data.params.target,success:()=>{setTimeout(()=>{this.handleStateChange()},500)}}):this.handleStateChange()},handleClose(){gio__default("track","in_app_message_"+this.data.messageProps.id+"_close"),confirmed=[...confirmed,this.data.messageProps.id],this.handleStateChange()},handleStateChange(){const e=Date.now(),t=this.data.matchedPopWindows.filter(t=>{const a=e>parseFloat(t.rule.startAt)&&parseFloat(t.rule.endAt)>e,s="appOpen"!==t.rule.action||t.rule.limit>t.showTimes,i=0>confirmed.indexOf(t.id);return a&&s&&i});t.sort((e,t)=>e.priority-t.priority!=0?e.priority-t.priority:t.updateAt-e.updateAt);const a=t[0],s=a?a.content:{},i=!!a,n={};i!==this.data.display&&(n.display=i),a&&!equals(a,this.data.messageProps)&&(n.messageProps=a,n.params=s),this.setData(n)}},observers:{"display, messageProps":function(e,t){if(e){gio__default("track","in_app_message_"+t.id+"_imp");const e=parseInt(wx.getStorageSync("gioMarketing:popupWindow:"+t.id)||0);wx.setStorageSync("gioMarketing:popupWindow:"+t.id,e+1)}}},detached(){gio.gioEmitter.removeListener("upload",this.handleEvent)},created(){componentCreated||(componentCreated=!0,updateMessageData()),this.handleEvent=(e=>{if("cstm"===e.t&&messageData&&!e.n.startsWith("in_app_message_")){const t=messageData.popupWindows.filter(t=>t.rule.action===e.n).map(e=>({showTimes:parseInt(wx.getStorageSync("gioMarketing:popupWindow:"+e.id)||0),...e}));this.setData({matchedPopWindows:t},()=>{this.handleStateChange()})}}).bind(this),gio.gioEmitter.addListener("upload",this.handleEvent)}});
